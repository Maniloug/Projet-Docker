# =============================================================================
# Docker Compose - PokéBoutique
# Configuration de développement (mode par défaut)
# =============================================================================
# Usage:
#   Dev:  docker compose up --build
#   Prod: docker compose -f compose.yaml -f compose.prod.yaml up --build
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Nginx - Reverse Proxy (Point d'entrée unique)
  # ---------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: pokeboutique-nginx
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - front_net
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Frontend - React/Vite
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: pokeboutique-frontend
    user: root
    environment:
      - NODE_ENV=development
      - VITE_API_URL=/api
    volumes:
      - ./frontend:/app
      - frontend_node_modules:/app/node_modules
    networks:
      - front_net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Backend - Node.js/Express API
  # ---------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development
    container_name: pokeboutique-backend
    user: root
    environment:
      - NODE_ENV=development
      - PORT=5000
      - MONGO_URI=mongodb://mongo:27017/pokemon_cards
    volumes:
      - ./backend:/app
      - backend_node_modules:/app/node_modules
    networks:
      - front_net
      - back_net
    depends_on:
      mongo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # MongoDB - Base de données
  # ---------------------------------------------------------------------------
  mongo:
    image: mongo:7.0
    container_name: pokeboutique-mongo
    environment:
      - MONGO_INITDB_DATABASE=pokemon_cards
    volumes:
      - mongo_data:/data/db
    networks:
      - back_net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    restart: unless-stopped

# =============================================================================
# Réseaux
# =============================================================================
networks:
  # Réseau frontal - Nginx, Frontend, Backend
  front_net:
    driver: bridge
    name: pokeboutique-front

  # Réseau interne - Backend, MongoDB (DB isolée)
  back_net:
    driver: bridge
    name: pokeboutique-back
    internal: true

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mongo_data:
    name: pokeboutique-mongo-data
  frontend_node_modules:
    name: pokeboutique-frontend-node-modules
  backend_node_modules:
    name: pokeboutique-backend-node-modules
